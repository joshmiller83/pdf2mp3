name: Test Badge

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  badge:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-asyncio nltk PyPDF2
        python -c "import nltk; nltk.download('punkt'); nltk.download('punkt_tab')"

    - name: Run tests and generate badge
      run: |
        pytest tests/ --tb=short > test_results.txt 2>&1 || true

        if grep -q "94 passed" test_results.txt; then
          echo "TESTS_PASSED=true" >> $GITHUB_ENV
          echo "BADGE_COLOR=green" >> $GITHUB_ENV
          echo "BADGE_MESSAGE=passing" >> $GITHUB_ENV
        else
          echo "TESTS_PASSED=false" >> $GITHUB_ENV
          echo "BADGE_COLOR=red" >> $GITHUB_ENV
          echo "BADGE_MESSAGE=failing" >> $GITHUB_ENV
        fi

    - name: Create badge
      uses: schneegans/dynamic-badges-action@v1.7.0
      if: github.event_name == 'push'
      with:
        auth: ${{ secrets.GIST_SECRET }}
        gistID: ${{ secrets.BADGE_GIST_ID }}
        filename: pdf2txt-tests.json
        label: tests
        message: ${{ env.BADGE_MESSAGE }}
        color: ${{ env.BADGE_COLOR }}
